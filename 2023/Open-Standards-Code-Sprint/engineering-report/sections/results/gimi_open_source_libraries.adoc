[[results_gimi_open_source_libraries]]
==== Towards open source libraries for GIMI

This section presents findings of prototyping GIMI support in a selection of open source libraries. The prototyping and assessment was carried out by Brad Hards.

Prior to the code sprint, a selection of GIMI files were produced using a custom application. These files were read back in using modified versions of libheif and GDAL,
where GDAL already used libheif for image content, but required an external "sidecar" PAM file to provide any geopositioning or associated metadata.

The changes to libheif were to support metadata that is not attached to an image item. This occurs in GIMI files for the security metadata, which is scoped to the entire
HEIF file content. The changes included suppressing a parsing error, and exposing the resulting metadata item through the libheif API.

The changes to GDAL were to support the security metadata as a GDAL metadata item, and to use the KLV metadata as a GDAL metadata item, and also to provide
corner point geopositioning. The changes to libheif enabled access to the security metadata. With these changes, GDAL was able to extract and expose the additional GIMI
metadata without use of sidecar files. An example showing the GIMI-specific metadata domains, along with GCPs and the derived coordinate system transformation, is 
shown below.

....
$ gdalinfo -mdd all ~/ogc-developer-events/2023/Open-Standards-Code-Sprint/publicly-releasable-sample-data/bradh/ACT2020_wgs_84_trimmed.heif 
Driver: HEIF/ISO/IEC 23008-12:2017 High Efficiency Image File Format
Files: /home/bradh/ogc-developer-events/2023/Open-Standards-Code-Sprint/publicly-releasable-sample-data/bradh/ACT2020_wgs_84_trimmed.heif
Size is 2048, 1024
Coordinate System is:
GEOGCRS["WGS 84",
    DATUM["World Geodetic System 1984",
        ELLIPSOID["WGS 84",6378137,298.257223563,
            LENGTHUNIT["metre",1]]],
    PRIMEM["Greenwich",0,
        ANGLEUNIT["degree",0.0174532925199433]],
    CS[ellipsoidal,2],
        AXIS["geodetic latitude (Lat)",north,
            ORDER[1],
            ANGLEUNIT["degree",0.0174532925199433]],
        AXIS["geodetic longitude (Lon)",east,
            ORDER[2],
            ANGLEUNIT["degree",0.0174532925199433]],
    ID["EPSG",4326]]
Data axis to CRS axis mapping: 2,1
Origin = (149.102048999999994,-35.315807000000000)
Pixel Size = (0.000001009277344,-0.000001009765625)
GCP Projection = 
GEOGCRS["WGS 84",
    DATUM["World Geodetic System 1984",
        ELLIPSOID["WGS 84",6378137,298.257223563,
            LENGTHUNIT["metre",1]]],
    PRIMEM["Greenwich",0,
        ANGLEUNIT["degree",0.0174532925199433]],
    CS[ellipsoidal,2],
        AXIS["geodetic latitude (Lat)",north,
            ORDER[1],
            ANGLEUNIT["degree",0.0174532925199433]],
        AXIS["geodetic longitude (Lon)",east,
            ORDER[2],
            ANGLEUNIT["degree",0.0174532925199433]],
    ID["EPSG",4326]]
Data axis to CRS axis mapping: 2,1
GCP[  0]: Id=GCP_1, Info=
          (0,0) -> (149.102049,-35.315807,0)
GCP[  1]: Id=GCP_2, Info=
          (2048,0) -> (149.104116,-35.315807,0)
GCP[  2]: Id=GCP_3, Info=
          (2048,1024) -> (149.104116,-35.316841,0)
GCP[  3]: Id=GCP_4, Info=
          (0,1024) -> (149.102049,-35.316841,0)
Metadata (GIMI File Security):
  XML=<?xml version="1.0" encoding="UTF-8" standalone="yes"?><FakeSecurity xmlns="http://www.opengis.net/CodeSprint2023Oct/Security"><FakeLevel>SECRETIVE-ISH</FakeLevel><FakeCaveat>ButterPopcorn</FakeCaveat><FakeCaveat>LowPlaces</FakeCaveat><FakeRelTo>US</FakeRelTo><FakeRelTo>AUS</FakeRelTo><FakeRelTo>UK</FakeRelTo><FakeDeclassOn>2024-11-01</FakeDeclassOn></FakeSecurity>
Metadata (GIMI ST0601):
  Checksum=0x5f 0x77
  Corner Latitude Point 1 (Full)=-35.315807
  Corner Latitude Point 2 (Full)=-35.315807
  Corner Latitude Point 3 (Full)=-35.316841
  Corner Latitude Point 4 (Full)=-35.316841
  Corner Longitude Point 1 (Full)=149.102049
  Corner Longitude Point 2 (Full)=149.104116
  Corner Longitude Point 3 (Full)=149.104116
  Corner Longitude Point 4 (Full)=149.102049
  Mission ID=Mission3
  Precision Time Stamp=1589944740032704
  ST 0601 Version=ST 0601.19
Metadata (DERIVED_SUBDATASETS):
  DERIVED_SUBDATASET_1_NAME=DERIVED_SUBDATASET:LOGAMPLITUDE:/home/bradh/ogc-developer-events/2023/Open-Standards-Code-Sprint/publicly-releasable-sample-data/bradh/ACT2020_wgs_84_trimmed.heif
  DERIVED_SUBDATASET_1_DESC=log10 of amplitude of input bands from /home/bradh/ogc-developer-events/2023/Open-Standards-Code-Sprint/publicly-releasable-sample-data/bradh/ACT2020_wgs_84_trimmed.heif
Corner Coordinates:
Upper Left  ( 149.1020490, -35.3158070) (149d 6' 7.38"E, 35d18'56.91"S)
Lower Left  ( 149.1020490, -35.3168410) (149d 6' 7.38"E, 35d19' 0.63"S)
Upper Right ( 149.1041160, -35.3158070) (149d 6'14.82"E, 35d18'56.91"S)
Lower Right ( 149.1041160, -35.3168410) (149d 6'14.82"E, 35d19' 0.63"S)
Center      ( 149.1030825, -35.3163240) (149d 6'11.10"E, 35d18'58.77"S)
Band 1 Block=2048x1 Type=Byte, ColorInterp=Red
Band 2 Block=2048x1 Type=Byte, ColorInterp=Green
Band 3 Block=2048x1 Type=Byte, ColorInterp=Blue
....

GDAL serves as a key component within the geospatial software ecosystem, with broad direct and indirect use by a wide range of open source and proprietary software.


image::images/ecosystem.png[]

Figure TBA shows a screenshot of an unmodified version of QGIS displaying two GIMI test files, overlaid on top of OpenStreetMap.

image::images/gimi_qgis_1.png[]

The sprint participants created a Jupyter Notebook, shown in Figure TBA, that used many of the aforementioned libraries to perform some data science analysis on GIMI imagery files.

image::images/gimi_jupyter_1.png[]

Further work on pygeoapi involved importing a GIMI file into pygeoapi for serving through an interface conforming to OGC API – Coverages. This exposed coverage metadata as illustrated in Figure TBA.

image::images/gimi_pygeoapi_coverage.png[]

Using the open source TiTiler toolkit, the sprint participants were able to partition GIMI test files into a tileset and to provision a pygeoapi instance with the tileset. This made it possible for the imagery to be accessible through an interface conforming to OGC API – Tiles and thus be displayed on an instance of OpenLayers.

image::images/gimi_openlayers.png[]

As a community we have an ecosystem that has some key dependencies that include GDAL + libheif, mp4box.js, rasterio, rio-tiler, pygeoapi etc. There are also some commercial libraries that sit alongside these open source libraries. GDAL is used by several applications such as GDAL. Rasterio is a very import tool. So the combination of tools and libraries presents a big stack is illustrated in Figure TBA. The sprint participants sought to show how this stack could be used to support GIMI.

In conclusion, the sprint participants found that there are a number of base libraries that are needed to improve the migration path for several applications. Amongst those base libraries are GDAL and libheif. Also needed are more tools, more examples of test data, and validators to facilitate the evaluation of test files.
